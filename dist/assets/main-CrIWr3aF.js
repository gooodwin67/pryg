import{B as be,a as te,P as ge,N as we,b as _e,c as ke,C as re,M as ce,d as Le,V as j,e as Me,f as Se,A as Ae,g as Ee,h as xe,T as Ce,i as se,G as ae,j as Pe,k as Te,S as qe,l as De,m as Ne,n as Be,W as Re,o as ze,p as He,q as Ie,r as I}from"./three-lHb6daVq.js";function Fe(){let l=window.matchMedia||window.msMatchMedia;return l?l("(pointer:coarse)").matches:!1}new Me(new j(-.5,-.5,-.5),new j(.5,.5,.5));new Se;function Ge({scene:l,maxParticles:e=800,gravity:t=-7.8,drag:s=2,texture:o=null,pointSize:i=.66,blending:r=we}={}){if(!l)throw new Error("createSplashSystem: scene is required");function u(){const k=document.createElement("canvas");k.width=k.height=64;const P=k.getContext("2d"),E=P.createRadialGradient(64/2,64/2,0,64/2,64/2,64/2);E.addColorStop(0,"rgba(255,255,255,1)"),E.addColorStop(1,"rgba(255,255,255,0)"),P.fillStyle=E,P.fillRect(0,0,64,64);const A=new re(k);return A.anisotropy=1,A.needsUpdate=!0,A}const n=o||u(),a=new Float32Array(e*3),m=new Float32Array(e*3),h=new Float32Array(e),d=new Float32Array(e),f=new Float32Array(e),c=new Uint8Array(e),y=new be;y.setAttribute("position",new te(a,3)),y.setAttribute("aSize",new te(f,1));const p=new ge({map:n,size:i,transparent:!0,depthWrite:!1,blending:r,vertexColors:!1,sizeAttenuation:!0}),v=new _e(y,p);v.userData.persistent=!0,v.frustumCulled=!1,v.position.set(0,-20,0),l.add(v);let b=0;function L(){for(let w=0;w<e;w++){const k=(b+w)%e;if(!c[k])return b=(k+1)%e,k}return-1}function R(w,k,P,E,A){const N=k*3;w[N]=P,w[N+1]=E,w[N+2]=A}return{trigger(w,k=1,P={}){const{count:E=42,spread:A=.35,up:N=3,horiz:G=2.2,ttl:_=[.35,.8],sizeJitter:M=.5}=P,J=Math.max(1,Math.floor(E*k));for(let $=0;$<J;$++){const T=L();if(T===-1)break;const z=Math.sqrt(Math.random())*A,B=Math.random()*Math.PI*2,de=z*Math.cos(B),me=z*Math.sin(B),ee=Math.sqrt(Math.random()),he=Math.cos(B)*G*ee*(.6+.4*Math.random()),pe=Math.sin(B)*G*ee*(.6+.4*Math.random()),fe=N*(.6+.4*Math.random()),ye=_[0]+Math.random()*(_[1]-_[0]),ve=(1-M/2+Math.random()*M)*1;R(a,T,w.x+de,w.y,w.z+me),R(m,T,he*k,fe*k,pe*k),h[T]=ye,d[T]=0,f[T]=ve,c[T]=1}y.attributes.position.needsUpdate=!0,y.attributes.aSize.needsUpdate=!0},update(w){if(w<=0)return;const k=t,P=Math.max(0,s);let E=!1;for(let _=0;_<e;_++){if(!c[_])continue;if(E=!0,d[_]+=w,d[_]>=h[_]){c[_]=0;const B=_*3;a[B]=1e9,a[B+1]=1e9,a[B+2]=1e9;continue}const M=_*3;m[M+1]+=k*w;const J=m[M],$=m[M+1],T=m[M+2],z=Math.max(0,1-P*w);m[M]=J*z,m[M+1]=$*z,m[M+2]=T*z,a[M]+=m[M]*w,a[M+1]+=m[M+1]*w,a[M+2]+=m[M+2]*w}E&&(y.attributes.position.needsUpdate=!0);let A=0,N=0;for(let _=0;_<e;_++)c[_]&&(A++,N+=1-d[_]/h[_]);const G=A?.25+.75*(N/A):1;p.size=i*G},get object3D(){return v},dispose(){l.remove(v),y.dispose(),p.dispose(),o||n.dispose()}}}function $e({scene:l,size:e=1.5,ttl:t=.9}={}){const s=new ke(1,1),o=(()=>{const f=document.createElement("canvas");f.width=f.height=64;const c=f.getContext("2d");return c.clearRect(0,0,64,64),c.strokeStyle="rgba(255,255,255,0.9)",c.lineWidth=3,c.beginPath(),c.arc(32,32,20,0,Math.PI*2),c.stroke(),new re(f)})(),i=new ce({map:o,transparent:!0,depthWrite:!1}),r=new Le(s,i);r.visible=!1,r.userData.persistent=!0,l.add(r);let u=0,n=!1;const a=new j;function m(f){a.copy(f),u=0,n=!0,r.visible=!0}function h(f,c){if(!n)return;if(u+=f,u>=t){n=!1,r.visible=!1;return}r.position.set(a.x,a.y+.01,a.z),r.rotation.set(-Math.PI/2,0,0);const y=u/t,p=e*(1+1.6*y);r.scale.setScalar(p),i.opacity=1-y}function d(){l.remove(r),s.dispose(),i.dispose(),o.dispose()}return{trigger:m,update:h,dispose:d,mesh:r}}const Y={ru:{ui:{langToggle:"EN"},title:"УТИНАЯ БРАТВА",modes:{champ:{title:"Чемпионат",desc:"Установите лучшее время (1,2,3 игрока)"},coop:{title:"Прохождение",desc:"Совместное прохождение уровней"},versus:{title:"Соревнование",desc:"Определите лучшего в прохождении"}},free:{playersTitle:"Сколько игроков",gameChoice:"Выбор игры",tip1:"Для каждого количества игроков своя таблица рекордов",tip2:"Учитывается пройденный путь каждого игрока в команде",tip3:"Управление одной кнопкой. 1й игрок мышкой, 2й и 3й кнопками",ocean:"Океан",space:"Космос"},levels:{playersTitle:"Сколько игроков",levelChoice:"Выбор уровня",tip1:"Проходите уровни разным количеством игроков",tip2:"Каждый раз, проходя 10й уровень, игрок получает 4 сердечко в режиме 'Чемпионат' на несколько попыток. 10 уровень всегда разный!",tip3:"Для прохождения уровня все игроки должны дойти до финиша",status:{completed:"Пройден",available:"Доступен",locked:"Закрыт",completedAria:"уровень пройден",availableAria:"уровень доступен",lockedAria:"уровень закрыт"}},contest:{playersTitle:"Сколько игроков",levelChoice:"Выбор уровня",random:"Случайный уровень",tip1:"Соревнуйтесь друг с другом. Побеждает тот, кто первый доберется до финиша",tip2:"Цвет уровня окрашивается в цвет победителя",tip3:"Цель - окрасить все уровни в свои цвета",player1:"Билли",player2:"Вилли",player3:"Дилли"},players:{billy:"Билли",willy:"Вилли",dilly:"Дилли",lives:"Жизни:"},hud:{metersLabel:"м",records:"Рекорды:",mine:"Мой:",world:"Мировой:",secPlayer:"Я",thirdPlayer:"Ь"},popup:{continue:"Продолжить +",next:"Следующий уровень",restart:"Начать заново",levelSelect:"Выбор уровня",exit:"Выйти в меню"},loader:{loading:"Загрузка..."},leaderboard:{mine:"Мой рекорд"},auth:{title:"Авторизуйтесь для участия в рекордах",cta:"Войти"}},en:{ui:{langToggle:"RU"},title:"DUCK BROS",modes:{champ:{title:"Championship",desc:"Set the best time (1,2,3 players)"},coop:{title:"Beat levels",desc:"Beat levels together"},versus:{title:"Versus",desc:"Find out who’s fastest"}},free:{playersTitle:"Players",gameChoice:"Game selection",tip1:"Each player count has its own leaderboard",tip2:"We sum distance traveled by each teammate",tip3:"One-button control. 1st player with the mouse, 2nd and 3rd buttons",ocean:"Ocean",space:"Space"},levels:{playersTitle:"Players",levelChoice:"Level selection",tip1:"Beat levels with different team sizes",tip2:"Each time you beat level 10 you get a 4th heart for a few championship attempts",tip3:"To finish a level, all players must reach the goal",status:{completed:"Completed",available:"Available",locked:"Locked",completedAria:"level completed",availableAria:"level available",lockedAria:"level locked"}},contest:{playersTitle:"Players",levelChoice:"Level selection",random:"Random level",tip1:"Race each other: first to finish wins",tip2:"The level gets dyed in the winner’s color",tip3:"Goal: dye all levels in your color",player1:"Billy",player2:"Willy",player3:"Dilly"},players:{billy:"Billy",willy:"Willy",dilly:"Dilly",lives:"Lives:"},hud:{metersLabel:"m",records:"Records:",mine:"Mine:",world:"World:",secPlayer:"Z",thirdPlayer:"M"},popup:{continue:"Continue +",next:"Next level",restart:"Restart",levelSelect:"Level select",exit:"Main menu"},loader:{loading:"Loading..."},leaderboard:{mine:"My record"},auth:{title:"Log in to participate in the records",cta:"LogIn"}}};function oe(l,e){return e.split(".").reduce((t,s)=>t&&t[s],l)}function K(l="ru",e=document){const t=Y[l]||Y.ru;if(e.querySelectorAll("[data-i18n]").forEach(o=>{const i=o.dataset.i18n,r=oe(t,i);r!=null&&(o.textContent=r)}),document.documentElement.lang=l,localStorage.setItem("locale",l),document.getElementById("lang-toggle")){const o=document.getElementById("flag");oe(t,"ui.langToggle")==="ru"||l==="ru"?(o.classList.remove("us"),o.classList.add("ru"),o.src="images/ru.svg"):(o.classList.remove("ru"),o.classList.add("us"),o.src="images/us.svg")}}function Oe(l,e){if(e!=null)K(e);else{const s=localStorage.getItem("locale")||"ru";K(s)}const t=document.getElementById("lang-toggle");document.getElementById("flag"),t&&t.addEventListener("click",()=>{const o=(localStorage.getItem("locale")||"ru")==="ru"?"en":"ru";K(o),l()})}function q(l,e=""){const t=localStorage.getItem("locale")||"ru",s=Y[t]||Y.ru;return l.split(".").reduce((i,r)=>i&&i[r],s)??e}new j;class Ve{constructor(){this.backAudio,this.backAudio2,this.backAudio3,this.oceanAudio,this.rainAudio,this.thunderAudio,this.thunderAudio2,this.thunderAudio3,this.thundersAudio=[],this.inwaterAudio,this.takeAudio,this.looseAudio,this.winAudio,this.readyJumpAudio,this.jumpAudio,this.jumpAudio2,this.jumpAudio3,this.quacks=[],this.musics=[],this.musicNowPlaying=[],this.musicDay=!0,this.musicNight=!1,this.timeToChange=2,this._attached=!1,this.listener=new Ae,this.musicOn=!0}hardStopAll(){this.musics.forEach(({music:e})=>{try{e.stop()}catch{}}),this.quacks.forEach(e=>{try{e.stop()}catch{}}),this.thundersAudio.forEach(e=>{try{e.music.stop()}catch{}}),this.musicNowPlaying=[]}toggleMute(e){e?(this.musicOn=!1,this.listener.context.suspend()):(this.musicOn=!0,this.listener.context.resume(),this.playMusic(["back"]))}isMuted(){return this.listener.context.state==="suspended"}attachTo(e){this._attached||(e.add(this.listener),this._attached=!0)}async loadAudio(){const e=new Ee,t=[{key:"backAudio",name:"back1",path:"audio/back1.mp3",loop:!0,ref:100,vol:2},{key:"backAudio2",name:"back2",path:"audio/back2.mp3",loop:!0,ref:100,vol:2},{key:"backAudio3",name:"back3",path:"audio/back3.mp3",loop:!0,ref:100,vol:.5},{key:"oceanAudio",name:"ocean",path:"audio/ocean.mp3",loop:!0,ref:100,vol:.4},{key:"inwaterAudio",name:"inwater",path:"audio/inwater.mp3",loop:!1,ref:200,vol:1},{key:"looseAudio",name:"loose",path:"audio/loose.mp3",loop:!1,ref:200,vol:1},{key:"winAudio",name:"win",path:"audio/win.mp3",loop:!1,ref:200,vol:2},{key:"takeAudio",name:"take",path:"audio/take.mp3",loop:!1,ref:200,vol:2},{key:"readyJumpAudio",name:"readyJump",path:"audio/ready-jump.mp3",loop:!1,ref:1e3,vol:200,rate:2},{key:"jumpAudio",name:"quack1",path:"audio/quack1.mp3",loop:!1,ref:2e3,vol:2,quack:!0},{key:"jumpAudio2",name:"quack2",path:"audio/quack2.mp3",loop:!1,ref:400,vol:.3,quack:!0},{key:"jumpAudio3",name:"quack3",path:"audio/quack3.mp3",loop:!1,ref:400,vol:.3,quack:!0},{key:"rainAudio",name:"rain",path:"audio/rain.mp3",loop:!0,ref:400,vol:1.5},{key:"thunderAudio",name:"thunder1",path:"audio/thunder.mp3",loop:!1,ref:400,vol:1,thunder:!0},{key:"thunderAudio2",name:"thunder2",path:"audio/thunder2.mp3",loop:!1,ref:400,vol:1,thunder:!0},{key:"thunderAudio3",name:"thunder3",path:"audio/thunder3.mp3",loop:!1,ref:400,vol:1,thunder:!0}];(await Promise.all(t.map(o=>e.loadAsync(o.path).catch(i=>(console.error(`Ошибка при загрузке ${o.path}:`,i),null))))).forEach((o,i)=>{const r=t[i];if(!o)return;const u=new xe(this.listener);u.setBuffer(o),u.setLoop(r.loop),u.setRefDistance(r.ref),u.setVolume(r.vol),r.rate&&u.setPlaybackRate(r.rate),this[r.key]=u,this.musics.push({name:r.name,music:u}),r.quack&&this.quacks.push(u),r.thunder&&this.thundersAudio.push({name:r.name,music:u})}),this.backAudio&&this.musics.push({name:"back",music:this.backAudio})}stopMusic(e){this.musicOn&&(e==0?this.musics.forEach((t,s,o)=>{t.music.stop()}):e.forEach((t,s,o)=>{this.musics.find(i=>i.name===t).music.stop()}))}pauseMusic(e){this.musicOn&&e.forEach((t,s,o)=>{this.musics.find(i=>i.name===t).music.pause()})}playMusic(e){e.forEach((t,s,o)=>{let i=this.musics.find(r=>r.name===t).music;!i.isPlaying&&this.musicOn&&i.play()})}togglePauseAll(e){this.musicOn&&(e?(this.musicNowPlaying=[],this.musics.forEach(({music:t})=>{t.isPlaying&&(t.pause(),this.musicNowPlaying.push(t))})):this.musicNowPlaying&&this.musicNowPlaying.length&&(this.musicNowPlaying.forEach(t=>{t.isPlaying||t.play()}),this.musicNowPlaying=[]))}dayNight(e=!0,t=!1){e&&!this.musicDay?this.timeToChange>0?(this.timeToChange-=.01,this.musics.find(s=>s.name==="back").music.setVolume(this.timeToChange)):(this.timeToChange=0,this.stopMusic(["back"]),this.musics.find(s=>s.name==="back").music.setVolume(2),this.musics.find(s=>s.name==="back").music=this.musics.find(s=>s.name==="back1").music,this.musicOn&&this.playMusic(["back"]),this.musicNight=!1,this.musicDay=!0,this.timeToChange=2,this.musics.find(s=>s.name==="back").music.setVolume(this.timeToChange)):!e&&!this.musicNight&&(this.timeToChange>0?(this.timeToChange-=.01,this.musics.find(s=>s.name==="back").music.setVolume(this.timeToChange)):(this.timeToChange=0,this.stopMusic(["back"]),this.musics.find(s=>s.name==="back").music.setVolume(2),this.musics.find(s=>s.name==="back").music=this.musics.find(s=>t?s.name==="back3":s.name==="back2").music,this.musicOn&&this.playMusic(["back"]),this.musicNight=!0,this.musicDay=!1,this.timeToChange=2,this.musics.find(s=>s.name==="back").music.setVolume(this.timeToChange)))}}class je{constructor(e,t,s,o){this.initMatch=e,this.gameClass=t,this.audioClass=s,this.dataClass=o,this.playersNum=1,this.levelPlayersNum=1}init(){this.mainMenu()}mainMenu(){const e=document.querySelector(".new_game_btn1"),t=document.querySelector(".new_game_btn2"),s=document.querySelector(".new_game_btn3"),o=document.querySelector(".contest_game_btn"),i=document.querySelector(".levels_blocks"),r=document.querySelector(".levels_blocks_contest");e&&e.addEventListener("click",()=>{this.loadRecsData(),this.hideScreen("main_screen"),this.showScreen("free_game_screen")}),t&&t.addEventListener("click",async()=>{this.dataClass.levelCoopMode="coop",document.querySelectorAll(".levels_game_screen .level_game_chels").forEach((a,m)=>{a.classList.contains("level_game_chels_active")&&(this.levelPlayersNum=m+1,this.dataClass.loadLevels(this.levelPlayersNum-1))}),this.hideScreen("main_screen"),this.showScreen("levels_game_screen")}),s&&s.addEventListener("click",async()=>{this.dataClass.levelCoopMode="contest",document.querySelectorAll(".levels_game_screen_contest .level_game_chels_contest").forEach((a,m)=>{a.classList.contains("level_game_chels_contest_active")&&(this.levelPlayersNum=m+2)}),this.hideScreen("main_screen"),this.showScreen("levels_game_screen_contest")}),document.querySelectorAll(".arrow_back").forEach(a=>{a.addEventListener("click",()=>{a.parentElement.parentElement.classList.add("hidden_screen"),this.showScreen("main_screen")})}),i&&i.addEventListener("click",a=>{const m=a.target.closest(".levels_block");if(!m||m.classList.contains("levels_block--locked"))return;const h=Number(m.dataset.level)||1;i.querySelectorAll(".levels_block").forEach(d=>d.classList.remove("active")),m.classList.add("active"),this.hideScreen("levels_game_screen"),this.initMatch(this.levelPlayersNum,1,h,!0)}),r&&r.addEventListener("click",a=>{const m=a.target.closest(".levels_block");if(!m)return;const h=Number(m.dataset.level)||1;r.querySelectorAll(".levels_block").forEach(d=>d.classList.remove("active")),m.classList.add("active"),this.hideScreen("levels_game_screen_contest"),this.initMatch(this.levelPlayersNum,1,h,!0)}),o&&o.addEventListener("click",()=>{const a=Math.floor(Math.random()*this.dataClass.allLevels);this.hideScreen("levels_game_screen_contest"),this.initMatch(this.levelPlayersNum,1,a,!0)}),document.querySelectorAll(".level_game_chels").forEach((a,m)=>{a.addEventListener("click",()=>{this.levelPlayersNum!==m+1&&(document.querySelectorAll(".level_game_chels").forEach(h=>{h.classList.remove("level_game_chels_active")}),a.classList.add("level_game_chels_active"),this.levelPlayersNum=m+1,this.dataClass.loadLevels(this.levelPlayersNum-1))})}),document.querySelectorAll(".level_game_chels_contest").forEach((a,m)=>{a.addEventListener("click",()=>{this.levelPlayersNum!==m+2&&(document.querySelectorAll(".level_game_chels_contest").forEach(h=>{h.classList.remove("level_game_chels_contest_active")}),a.classList.add("level_game_chels_contest_active"),this.levelPlayersNum=m+2)})});const u=document.querySelector(".free_game_btn1_2"),n=document.querySelector(".free_game_btn1_4");u&&u.addEventListener("click",()=>{ym(105298813,"reachGoal","play_ocean"),this.hideScreen("free_game_screen"),this.initMatch(this.playersNum,2)}),n&&n.addEventListener("click",()=>{ym(105298813,"reachGoal","play_space"),this.hideScreen("free_game_screen"),this.initMatch(this.playersNum,4,!1,!1)}),document.querySelectorAll(".free_game_chels").forEach((a,m)=>{a.addEventListener("click",()=>{document.querySelectorAll(".free_game_chels").forEach(p=>{p.classList.remove("free_game_chels_active")}),a.classList.add("free_game_chels_active");const h=m+1,d=document.querySelectorAll(".rec_table_small"),f=[];d.forEach(p=>{const v=p.querySelector(".rec_table_small_block:not(.hidden_screen)");v&&(f.push(v),v.getBoundingClientRect(),v.classList.add("anim-out"))});let c=0;const y=()=>{if(c++,c<f.length)return;this.playersNum=h,this.loadRecsData();const p=[];document.querySelectorAll(".rec_table_small").forEach(v=>{const b=v.querySelector(".rec_table_small_block:not(.hidden_screen)");b&&(b.classList.add("anim-in"),p.push(b))}),requestAnimationFrame(()=>{p.forEach(b=>{b.getBoundingClientRect(),b.classList.add("anim-play")});const v=b=>{b.classList.remove("anim-in","anim-play"),b.removeEventListener("transitionend",v)};p.forEach(b=>b.addEventListener("transitionend",()=>v(b),{once:!0}))})};f.length===0?(this.playersNum=h,this.loadRecsData()):f.forEach(p=>{p.addEventListener("transitionend",()=>{p.classList.remove("anim-out"),p.removeEventListener("transitionend",y),y()},{once:!0})})})})}toggleLoader(e){const t=document.querySelector(".loader_screen");t&&(e?t.classList.remove("hidden_screen"):t.classList.add("hidden_screen"))}hideScreen(e){const t=document.querySelector(`.${e}`);t&&t.classList.add("hidden_screen")}showScreen(e){const t=document.querySelector(`.${e}`);t&&t.classList.remove("hidden_screen")}}class Ye{constructor(){this.gameStarting=!1,this.pause=!1,this.visible=!0,this.showGamePopup=!1}}class Ue{constructor(){this.gameInit=!1,this.yandexPlayer={id:0,player:null},this.levelsStatus=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.levelCoopMode="coop",this.allLevels=10,this.table={updateDate:11147,levelsStatusContest:[0,0,0,0,0,0,0,0,0,0],player:{levels:[0,0,0],bonusHat:[!1,!1,!1],bonusHeart:[0,0,0]},hor:[[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}],[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}],[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}]],vert:[[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}],[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}],[{pos:0,name:"Мой рекорд",rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}]]},this.masTables=[],this.mainScore=0,this.localStorageKey="gameData",this.disableSelection=()=>{document.querySelectorAll(".levels_block, .status_chip, .levels_block_number").forEach(t=>{t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.webkitTapHighlightColor="transparent",t.draggable=!1})},this.leaderboardsPartIds=["ocean1","ocean2","ocean3","space1","space2","space3"],this.leaderboardPlacement={ocean1:{group:"hor",row:0},ocean2:{group:"hor",row:1},ocean3:{group:"hor",row:2},space1:{group:"vert",row:0},space2:{group:"vert",row:1},space3:{group:"vert",row:2}}}async clearData(){localStorage.clear()}getMineLabel(){return q("leaderboard.mine","Мой рекорд")}refreshMineLabels(){const e=this.getMineLabel(),t=new Set(["Мой рекорд","My record"]),s=o=>{if(o){o[0]&&(o[0].name=e);for(let i=1;i<=3;i++){const r=o[i];r&&(r.isMe===!0||t.has(r.name))&&(r.name=e,r.isMe=!0)}}};["hor","vert"].forEach(o=>{if(this.table[o])for(let i=0;i<3;i++)s(this.table[o][i])}),this.processDataAfterLoad()}async loadLevels(e){const t=document.querySelector(".levels_blocks");if(!t)return;t.classList.add("levels_blocks--reenter"),t.innerHTML="";const s=document.createDocumentFragment(),o=n=>{switch(n){case"completed":return{modifierClass:"levels_block--completed",labelText:q("levels.status.completed","Пройден"),ariaState:q("levels.status.completedAria","уровень пройден")};case"available":return{modifierClass:"levels_block--available",labelText:q("levels.status.available","Доступен"),ariaState:q("levels.status.availableAria","уровень доступен")};default:return{modifierClass:"levels_block--locked",labelText:q("levels.status.locked","Закрыт"),ariaState:q("levels.status.lockedAria","уровень закрыт")}}},i=40,r=60,u=600;for(let n=0;n<this.levelsStatus[e].length;n++){const a=this.levelsStatus[e][n],{modifierClass:m,labelText:h,ariaState:d}=o(a),f=n===9,c=document.createElement("div");c.className=`levels_block ${m}${f?" levels_block--super":""}`,c.setAttribute("data-level",String(n+1)),c.setAttribute("role","button"),c.setAttribute("tabindex",a==="locked"?"-1":"0"),c.setAttribute("aria-label",`Уровень ${n+1}, ${d}${f?", бонусный уровень":""}`);const y=Math.min(r+n*i,u);c.style.setProperty("--show-delay",`${y}ms`);const p=document.createElement("div");if(p.className="levels_block_number",p.textContent=String(n+1),f){const L=document.createElement("div");L.className="level_reward_icon",L.innerHTML="+❤️",c.appendChild(L)}const v=document.createElement("div");v.className="levels_block_status";const b=document.createElement("span");b.className=`status_chip ${a==="completed"?"status_chip--completed":a==="available"?"status_chip--available":"status_chip--locked"}`,b.setAttribute("data-i18n",`levels.status.${a}`),b.textContent=h,v.appendChild(b),c.append(p,v),c.addEventListener("click",()=>{a!=="locked"&&(document.querySelectorAll(".levels_block").forEach(L=>L.classList.remove("active")),c.classList.add("active"))}),c.addEventListener("keydown",L=>{a!=="locked"&&(L.key==="Enter"||L.key===" ")&&(L.preventDefault(),c.click())}),s.appendChild(c)}t.append(s),requestAnimationFrame(()=>{t.classList.remove("levels_blocks--reenter"),t.querySelectorAll(".levels_block").forEach(n=>{n.classList.add("levels_block--enter"),n.classList.contains("levels_block--super")&&n.addEventListener("animationend",a=>{a.animationName==="level-tile-in"&&n.classList.add("levels_block--enter-done")})})}),this.disableSelection()}async loadLevelsContest(){const e=document.querySelector(".levels_blocks_contest");if(!e)return;e.classList.add("levels_blocks--reenter"),e.innerHTML="";const t=document.createDocumentFragment(),s=40,o=60,i=600;for(let r=0;r<this.allLevels;r++){const u=r+1,n=this.table.levelsStatusContest?.[r]??0,a=document.createElement("div");a.className="levels_block levels_block--contest",a.setAttribute("data-level",u),a.setAttribute("role","button"),a.setAttribute("tabindex","0"),a.setAttribute("aria-label",`Уровень ${u}, значение ${n}`);const m=Math.min(o+r*s,i);a.style.setProperty("--show-delay",`${m}ms`),n&&a.classList.add(`level_player${n}`);const h=document.createElement("div");h.className="levels_block_number",h.textContent=String(u);const d=document.createElement("div");d.className="levels_block_status",n?(d.setAttribute("data-i18n",`contest.player${n}`),d.textContent=q(`contest.player${n}`)):d.textContent="";const f=n?q(`contest.player${n}`):"";d.textContent=f,a.append(h,d),a.addEventListener("click",()=>{document.querySelectorAll(".levels_block").forEach(c=>c.classList.remove("active")),a.classList.add("active")}),a.addEventListener("keydown",c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),a.click())}),t.append(a)}e.append(t),requestAnimationFrame(()=>{e.classList.remove("levels_blocks--reenter"),e.querySelectorAll(".levels_block").forEach(r=>{r.classList.add("levels_block--enter")})}),this.disableSelection()}replayLevelsEnterAnimation(){const e=document.querySelector(".levels_blocks");if(!e)return;Array.from(e.querySelectorAll(".levels_block")).forEach(s=>{s.classList.remove("levels_block--enter"),s.offsetWidth,s.classList.add("levels_block--enter")})}processDataAfterLoad(){const e=t=>{const s=this.getMineLabel(),o=[t[1],t[2],t[3]].map((a,m)=>a?{pos:a.pos,name:a.name,rec:a.rec}:{pos:m+1,name:"",rec:0}),i=o.some(a=>a&&a.name===s),r=Number(t?.[0]?.rec)||0,u=t?.[3]?.name===s&&Number(t[3].rec)||0,n=Math.max(r,u);if(i)return o;{const a={pos:t?.[3]?.name===s&&t[3].pos||0,name:s,rec:n};return[o[0],o[1],o[2],a]}};this.masTables=[[e(this.table.hor[0]),e(this.table.hor[1]),e(this.table.hor[2])],[e(this.table.vert[0]),e(this.table.vert[1]),e(this.table.vert[2])]];for(let t=0;t<3;t++)for(let s=0;s<this.allLevels;s++)s<this.table.player.levels[t]?this.levelsStatus[t][s]="completed":s==this.table.player.levels[t]?this.levelsStatus[t][s]="available":this.levelsStatus[t][s]="locked"}async initYandexPlayer({force:e=!1}={}){try{(!this.yandexPlayer.player||e)&&(this.yandexPlayer.player=await ysdk.getPlayer()),this.yandexPlayer.isAuthorized=await this.yandexPlayer.player.isAuthorized()}catch{this.yandexPlayer.isAuthorized=!1}const t=document.querySelector(".autoriz");t&&(this.yandexPlayer.isAuthorized&&console.log("авторизовались"),t.classList.toggle("hidden_screen",this.yandexPlayer.isAuthorized===!0),this.yandexPlayer.isAuthorized===!0&&(t.setAttribute("aria-hidden","true"),t.style.display="none"))}async loadTableFromCloud(){await this.initYandexPlayer();try{const e=await this.yandexPlayer.player.getData(["table"]);e&&e.table&&typeof e.table=="object"?this.table=e.table:(console.log("Первый вход: создаём новую table"),this.table=this.createDefaultTable(),await this.saveTableToCloud())}catch(e){console.warn("Cloud load failed:",e),this.table=this.createDefaultTable()}this.processDataAfterLoad()}createDefaultTable(){return{updateDate:Date.now(),player:{levels:[0,0,0],bonusHat:[!1,!1,!1],bonusHeart:[0,0,0]},levelsStatusContest:[0,0,0,0,0,0,0,0,0,0],hor:[[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}],[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}],[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}]],vert:[[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}],[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}],[{pos:0,name:this.getMineLabel(),rec:0},{},{},{}]]}}async saveTableToCloud({flush:e=!1}={}){await this.initYandexPlayer();try{await this.yandexPlayer.player.setData({table:this.table},e)}catch(t){console.warn("Cloud save failed:",t)}}ensureRowsForLeaderboards(){const e=()=>[{pos:0,name:this.getMineLabel(),rec:0},{pos:1,name:"",rec:0},{pos:2,name:"",rec:0},{pos:3,name:"",rec:0}];this.table.hor||(this.table.hor=[e(),e(),e()]),this.table.vert||(this.table.vert=[e(),e(),e()]);for(let t=0;t<3;t++)(!Array.isArray(this.table.hor[t])||this.table.hor[t].length!==4)&&(this.table.hor[t]=e()),(!Array.isArray(this.table.vert[t])||this.table.vert[t].length!==4)&&(this.table.vert[t]=e())}applyLocalMyBestToTop3(){this.yandexPlayer?.isAuthorized||["hor","vert"].forEach(e=>{for(let t=0;t<3;t++){const s=this.table?.[e]?.[t];if(!s)continue;const o=Number(s?.[0]?.rec)||0;o>0&&this.updateLocalTop3(e,t,o)}})}async loadLeaderboardsTop3(e){await this.initYandexPlayer(),this.ensureRowsForLeaderboards();const t=!!this.yandexPlayer.isAuthorized,s=t&&this.yandexPlayer.player?.getUniqueID?this.yandexPlayer.player.getUniqueID():null,o=async i=>{try{const u=((await e.leaderboards.getEntries(i,{quantityTop:3,includeUser:!1,quantityAround:0})).entries||[]).map(d=>({uid:d.player?.uniqueID||null,name:d.player?.publicName||"Anon",rec:typeof d.score=="number"?d.score:0,pos:d.rank||0}));let n=null;if(t&&await e.isAvailableMethod("leaderboards.getPlayerEntry"))try{n=await e.leaderboards.getPlayerEntry(i)}catch{n=null}let a=[];if(t&&n&&s){const d=n.rank||0,f=typeof n.score=="number"?n.score:0;if(u.some(p=>p.uid===s))a=u.slice(0,3).map(p=>({pos:p.pos,name:p.uid===s?this.getMineLabel():p.name,rec:p.rec,isMe:p.uid===s}));else{const p=u.filter(b=>b.uid!==s).slice(0,2).map(b=>({pos:b.pos,name:b.name,rec:b.rec})),v={pos:d,name:this.getMineLabel(),rec:f,isMe:!0};a=[...p,v]}const y=this.leaderboardPlacement[i];if(y){const p=y.group==="hor"?this.table.hor[y.row]:this.table.vert[y.row];p&&p[0]&&(p[0].rec=f)}}else a=u.slice(0,3).map(d=>({pos:d.pos,name:d.name,rec:d.rec}));const m=this.leaderboardPlacement[i];if(!m)return;const h=m.group==="hor"?this.table.hor[m.row]:this.table.vert[m.row];for(let d=1;d<=3;d++){const f=a[d-1]||{pos:d,name:"",rec:0};h[d]={pos:f.pos,name:f.name,rec:f.rec,isMe:!!f.isMe}}if(t&&!a.some(f=>f.isMe||f?.name===this.getMineLabel())&&n&&s){const f=n.rank||0,c=typeof n.score=="number"?n.score:0;h[3]={pos:f,name:this.getMineLabel(),rec:c}}}catch(r){console.warn(`Leaderboard ${i} load failed:`,r);const u=this.leaderboardPlacement[i];if(!u)return;const n=u.group==="hor"?this.table.hor[u.row]:this.table.vert[u.row];for(let a=1;a<=3;a++)n[a]={pos:a,name:"",rec:0}}};await Promise.all(this.leaderboardsPartIds.map(o)),this.refreshMineLabels(),this.applyLocalMyBestToTop3(),this.processDataAfterLoad()}async submitMyScore(e,t,s){const o=Number(s)||0;try{if(!await e.isAvailableMethod("leaderboards.setScore"))return;const r=this.getMineLabel();this.mainScore=[...this.table.hor,...this.table.vert].reduce((u,n)=>{const a=Number(n?.[0]?.rec)||0,m=n?.[3]?.name===r&&Number(n[3].rec)||0;return u+Math.max(a,m)},0),setTimeout(async()=>{try{await e.leaderboards.setScore(t,o)}catch(u){console.warn("setScore (part) failed:",u)}},0),setTimeout(async()=>{try{await e.leaderboards.setScore("main",this.mainScore)}catch(u){console.warn("setScore (main) failed:",u)}},1200)}catch(i){console.warn("Submit score failed:",i)}}updateLocalTop3(e,t,s){const o=this.getMineLabel(),i=this.table?.[e]?.[t];if(!i)return;const r=(h,d)=>({pos:h?.pos??d,name:h?.name??"",rec:Number(h?.rec)||0,isMe:!!h?.isMe||h?.name===o}),u=Number(s)||0;i[0]=i[0]||{pos:0,name:o,rec:0},i[0].name=o,i[0].rec=Math.max(Number(i[0].rec)||0,u);let n=[r(i[1],1),r(i[2],2),r(i[3],3)];const a=n.findIndex(h=>h.isMe),m=Math.max(u,Number(i[0].rec)||0);if(a>=0)n[a].name=o,n[a].isMe=!0,n[a].rec=Math.max(n[a].rec,m),n=n.sort((h,d)=>d.rec-h.rec).slice(0,3);else{const h=n[2]?.rec||0;if(m>h)n.push({pos:0,name:o,rec:m,isMe:!0}),n=n.sort((d,f)=>f.rec-d.rec).slice(0,3);else{const d=n.filter(p=>!p.isMe).sort((p,v)=>v.rec-p.rec),f=d[0]||{pos:1,name:"",rec:0},c=d[1]||{pos:2,name:"",rec:0},y={pos:i[3]?.pos||0,name:o,rec:m,isMe:!0};n=[f,c,y]}}for(let h=1;h<=3;h++){const d=n[h-1]||{pos:h,name:"",rec:0};i[h]={pos:d.pos,name:d.name,rec:d.rec,isMe:!!d.isMe}}this.processDataAfterLoad()}}class We{constructor(){this.plane={texture:null,material:null},this.planeGrass={texture:null,material:null},this.mks={texture:null,material:null},this.angryBirdModel,this.boostHatModel,this.boostHatPropeller,this.boostHatMesh}async loadTexture(){const e=new Ce,[t,s,o]=await Promise.all([e.loadAsync("textures/plane.jpg"),e.loadAsync("textures/grass.jpg"),e.loadAsync("textures/mks.png")]);this.plane.texture=t,this.plane.material=new se({map:t,transparent:!0,opacity:1}),this.planeGrass.texture=s,this.planeGrass.material=new se({map:s}),this.mks.texture=o,this.mks.material=new ce({map:o,transparent:!0,opacity:0})}async loadModels(){await new ae().loadAsync("models/bird/bird.glb").then(s=>{const o=s.scene,i=s.animations;o.scale.x=2,o.scale.y=2,o.scale.z=2,o.position.y=0,o.rotation.y=-Math.PI/3,this.angryBirdModel=o,this.angryBirdModel.userData.mixer=new Pe(this.angryBirdModel),this.angryBirdModel.userData.action=this.angryBirdModel.userData.mixer.clipAction(i[0]),this.angryBirdModel.userData.action.play(),this.angryBirdModel.userData.clock=new Te,this.angryBirdModel.traverse(u=>{(u.isMesh||u.isSkinnedMesh)&&(u.castShadow=!1,u.receiveShadow=!1,u.geometry&&!u.geometry.boundingSphere&&u.geometry.computeBoundingSphere())});const r=this.angryBirdModel.children[0].children[0].material;r.emissive.set(16777215),r.emissiveIntensity=.1})}async loadBoostsModel(){await new ae().loadAsync("models/boosts/hat.glb").then(s=>{const o=s.scene;this.boostHatModel=o,this.boostHatPropeller=this.boostHatModel.children[0].children[1],this.boostHatMesh=this.boostHatModel.children[0].children[0].children[0];const i=this.boostHatPropeller.children[0].material;i.emissive.set(16777215),i.emissiveIntensity=0,this.boostHatModel.rotation.x=Math.PI/17,this.boostHatModel.rotation.y=Math.PI/2,this.boostHatModel.position.y=2,this.boostHatModel.position.x=-40,this.boostHatModel.scale.x=.035,this.boostHatModel.scale.y=.035,this.boostHatModel.scale.z=.035,this.boostHatModel.userData.fly=!1,this.boostHatModel.userData.num=0})}}document.addEventListener("contextmenu",l=>(l.preventDefault(),!1),{capture:!0});document.addEventListener("selectstart",l=>(l.preventDefault(),!1),{capture:!0});document.addEventListener("dragstart",l=>(l.preventDefault(),!1),{capture:!0});document.addEventListener("touchstart",l=>{l.touches.length>1&&l.preventDefault()},{passive:!1});let Z;document.addEventListener("touchstart",l=>{Z=setTimeout(()=>{l.preventDefault()},500)},{passive:!1});document.addEventListener("touchend",()=>{clearTimeout(Z)});document.addEventListener("touchmove",()=>{clearTimeout(Z)});document.addEventListener("dblclick",l=>(l.preventDefault(),!1),{capture:!0});(navigator.userAgent.includes("YaBrowser")||navigator.userAgent.includes("Yandex"))&&document.addEventListener("touchstart",l=>{l.preventDefault()},{passive:!1});let ie,Je,U,S,D,O,g=new Ye;const Q=new qe;Q.background=new De(13230580);Ge({scene:Q});$e({scene:Q});const V=new Ne(25,window.innerWidth/window.innerHeight,.1,2e3);V.position.y=2;const Ke=16/9,Xe=I.degToRad(25),Ze=2*Math.atan(Math.tan(Xe/2)*Ke);Fe();function W(){const l=(window.visualViewport?.height||window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",`${l}px`)}W();window.addEventListener("resize",W);window.addEventListener("orientationchange",W);window.visualViewport?.addEventListener("resize",W);new Be;const C=new Re({antialias:!1});C.setPixelRatio(Math.min(window.devicePixelRatio,1));C.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(C.domElement);C.shadowMap.enabled=!0;C.shadowMap.type=ze;C.outputColorSpace=He;C.toneMapping=Ie;C.toneMappingExposure=1.05;function ue(){const l=document.body.offsetWidth,e=document.body.offsetHeight,t=l/e;let s=2*Math.atan(Math.tan(Ze/2)/t);const o=I.degToRad(4),i=I.degToRad(90);s=I.clamp(s,o,i),V.fov=I.radToDeg(s),V.aspect=t,V.updateProjectionMatrix(),C.setSize(l,e)}window.addEventListener("resize",ue);ue();let H=document.querySelector(".loader_line");async function Qe(){X(!0),D=new Ue;const l=ysdk.environment.i18n.lang.toLowerCase();Oe(()=>D.refreshMineLabels(),l),O=new We,await O.loadModels(),await O.loadBoostsModel(),H.setAttribute("style","width:30%"),await O.loadTexture(),await tt(),H.setAttribute("style","width:30%"),S=new Ve,await S.loadAudio(),H.setAttribute("style","width:60%"),await D.loadTableFromCloud(),await D.loadLeaderboardsTop3(ysdk),await D.loadLevels(0),await D.loadLevelsContest(),H.setAttribute("style","width:100%"),ie=new je,ie.init(),ysdk.features.LoadingAPI.ready(),ysdk.features.GameplayAPI.stop(),X(!1),H.setAttribute("style","width:0%")}(async function(){try{await Qe()}catch(e){X(!1),et(e)}})();function et(l){let e="Init error";typeof l=="string"?e+=`:
`+l:l&&(l.message&&(e+=": "+l.message),l.stack&&(e+=`
`+l.stack));const t=document.createElement("div");t.className="debug_error_overlay",t.textContent=e,document.body.appendChild(t)}async function tt(){["images/back-win.jpg","images/back-loose.jpg","images/back-dead.jpg","images/main.jpg"].forEach(l=>{const e=new Image;e.decoding="async",e.src=l})}C.setAnimationLoop(()=>{});function X(l){const e=document.querySelector(".loader_screen");e&&(l?e.classList.remove("hidden_screen"):e.classList.add("hidden_screen"))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?(!g.pause&&!g.showGamePopup&&(g.gameStarting=!0,S.togglePauseAll(!g.gameStarting)),g.visible=!0):(!g.pause&&!g.showGamePopup?(g.gameStarting=!1,S.togglePauseAll(!g.gameStarting)):g.pause||S.togglePauseAll(!g.gameStarting),g.visible=!1)});document.querySelector(".autoriz_btn").addEventListener("click",async()=>{try{await ysdk.auth.openAuthDialog()}catch{}await D.initYandexPlayer({force:!0}),await D.loadTableFromCloud(),await D.loadLeaderboardsTop3(ysdk)});document.querySelector(".pause_btn_wrap").addEventListener("click",()=>{!g.pause&&g.gameStarting&&(g.pause=!g.pause,g.pause&&(U.showPopupInGame(),g.gameStarting=!1,S.togglePauseAll(!g.gameStarting),U.showScreen("popup_game_btn_close")))});document.querySelector(".popup_game_btn_close").addEventListener("click",()=>{(g.pause||g.gameStarting)&&(g.pause=!g.pause,g.gameStarting=!0,S.togglePauseAll(!g.gameStarting),Je.rain&&!S.rainAudio.isPlaying&&S.rainAudio.play(),S.oceanAudio.isPlaying||S.oceanAudio.play(),U.hideScreen("popup_in_game"),U.hideScreen("popup_game_btn_close"))});document.querySelector(".sound_btn_wrap").addEventListener("click",()=>{const l=S.isMuted();S.toggleMute(!l),document.querySelector(".volume-icon__input").classList.toggle("volume_off")});function st(){const l=[".free_game_screen",".levels_game_screen",".levels_game_screen_contest",".main_screen"];let e=null,t=null,s=null,o=!1,i=0,r=0;const u=()=>{for(const c of l){const y=document.querySelector(c);if(y&&!y.classList.contains("hidden_screen"))return y}return null},n=()=>{const c=u();c!==e&&(e&&e.removeEventListener("scroll",a,{passive:!0}),s&&(s.removeEventListener("mousedown",m),s.removeEventListener("touchstart",m)),e=c,t=e?e.querySelector(".scroll-progress"):null,s=t?t.querySelector(".scroll-progress__bar"):null,e&&e.addEventListener("scroll",a,{passive:!0}),s&&(s.addEventListener("mousedown",m),s.addEventListener("touchstart",m)),a())},a=()=>{if(!e||!t||!s)return;const c=e.clientHeight,y=e.scrollHeight,p=e.scrollTop;if(y<=c+1){t.classList.remove("visible");return}t.classList.add("visible");const v=t.getBoundingClientRect().height,L=Math.max(c/y*v,24),R=y-c,F=v-L,w=R>0?p/R*F:0;s.style.height=`${L}px`,s.style.top=`${w}px`},m=c=>{!e||!s||(o=!0,i=c.touches?c.touches[0].clientY:c.clientY,r=e.scrollTop,document.body.style.userSelect="none",c.preventDefault())},h=c=>{if(!o||!e||!s||!t)return;const p=(c.touches?c.touches[0].clientY:c.clientY)-i,v=t.getBoundingClientRect().height,b=e.clientHeight,L=e.scrollHeight,R=Math.max(1,v-s.offsetHeight),F=(L-b)/R;e.scrollTop=r+p*F},d=()=>{o=!1,document.body.style.userSelect=""};window.addEventListener("resize",()=>{n(),a()}),window.addEventListener("mousemove",h,{passive:!1}),window.addEventListener("touchmove",h,{passive:!1}),window.addEventListener("mouseup",d),window.addEventListener("touchend",d),new MutationObserver(()=>{n()}).observe(document.body,{attributes:!0,subtree:!0,attributeFilter:["class"]}),n()}st();const x=document.querySelector(".popup_in_game_wrap");if(x){let l=0;x.addEventListener("touchstart",function(t){!t.touches||t.touches.length===0||(l=t.touches[0].clientY,x.scrollTop)},{passive:!0}),x.addEventListener("touchmove",function(t){if(!t.touches||t.touches.length===0)return;if(!(x.scrollHeight>x.clientHeight)){t.preventDefault();return}const i=t.touches[0].clientY-l,r=x.scrollTop<=0,u=x.scrollTop+x.clientHeight>=x.scrollHeight-1,n=i>0,a=i<0;(r&&n||u&&a)&&t.preventDefault()},{passive:!1})}const ne=document.querySelector(".popup_in_game");ne&&ne.addEventListener("touchmove",function(l){l.target.closest(".popup_in_game_wrap")||l.preventDefault()},{passive:!1});const le=document.querySelector(".loader_screen");le&&le.addEventListener("touchmove",function(l){l.preventDefault()},{passive:!1});
